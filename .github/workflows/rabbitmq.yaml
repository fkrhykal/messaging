name: RabbitMQ

on:
    push:
        branches: ["main"]

jobs:
    build:
        runs-on: ubuntu-latest

        services:
            msg-rabbit-mq:
                image: docker.io/rabbitmq:4.2.1-management-alpine
                ports:
                    - "15672:15672"
                    - "5672:5672"
                options: >-
                    # Use the main AMQP port 5672 for a dial check
                    --health-cmd="nc -z localhost 5672 || exit 1" 
                    --health-interval=5s
                    --health-timeout=2s
                    --health-retries=40 # Increased retries for stability
            msg-jaeger:
                image: docker.io/jaegertracing/jaeger:2.12.0
                ports:
                    - "16686:16686"
                    - "4317:4317"
                options: >-
                    # Use the OTLP/gRPC port 4317 for a dial check
                    --health-cmd="nc -z localhost 4317 || exit 1"
                    --health-interval=5s
                    --health-timeout=2s
                    --health-retries=40 # Increased retries for stability
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.25"

            - name: Run Go tests
              run: go test github.com/fkrhykal/messaging/rabbitmq -v

            - name: Run Go build
              run: go build ./rabbitmq
